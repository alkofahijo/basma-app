USE `basmadb`;
CREATE TABLE `reports` (
  `id` int unsigned NOT NULL AUTO_INCREMENT,
  `report_code` varchar(100) COLLATE utf8mb4_bin NOT NULL,
  `report_type_id` int unsigned NOT NULL,
  `name_ar` varchar(200) COLLATE utf8mb4_bin NOT NULL,
  `description_ar` mediumtext COLLATE utf8mb4_bin NOT NULL,
  `note` mediumtext COLLATE utf8mb4_bin,
  `image_before_url` varchar(500) COLLATE utf8mb4_bin NOT NULL,
  `image_after_url` varchar(500) COLLATE utf8mb4_bin DEFAULT NULL,
  `status_id` int unsigned NOT NULL,
  `reported_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `adopted_by_id` int unsigned DEFAULT NULL,
  `adopted_by_type` int DEFAULT NULL,
  `government_id` int unsigned NOT NULL,
  `district_id` int unsigned NOT NULL,
  `area_id` int unsigned NOT NULL,
  `location_id` int unsigned NOT NULL,
  `user_id` int unsigned DEFAULT NULL,
  `reported_by_name` varchar(200) COLLATE utf8mb4_bin DEFAULT NULL,
  `is_active` smallint NOT NULL DEFAULT '1',
  `created_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `report_code` (`report_code`),
  KEY `report_type_id` (`report_type_id`),
  KEY `status_id` (`status_id`),
  KEY `government_id` (`government_id`),
  KEY `district_id` (`district_id`),
  KEY `area_id` (`area_id`),
  KEY `location_id` (`location_id`),
  KEY `user_id` (`user_id`),
  CONSTRAINT `reports_ibfk_1` FOREIGN KEY (`report_type_id`) REFERENCES `report_types` (`id`) ON DELETE RESTRICT ON UPDATE RESTRICT,
  CONSTRAINT `reports_ibfk_2` FOREIGN KEY (`status_id`) REFERENCES `report_status` (`id`) ON DELETE RESTRICT ON UPDATE RESTRICT,
  CONSTRAINT `reports_ibfk_3` FOREIGN KEY (`government_id`) REFERENCES `governments` (`id`) ON DELETE RESTRICT ON UPDATE RESTRICT,
  CONSTRAINT `reports_ibfk_4` FOREIGN KEY (`district_id`) REFERENCES `districts` (`id`) ON DELETE RESTRICT ON UPDATE RESTRICT,
  CONSTRAINT `reports_ibfk_5` FOREIGN KEY (`area_id`) REFERENCES `areas` (`id`) ON DELETE RESTRICT ON UPDATE RESTRICT,
  CONSTRAINT `reports_ibfk_6` FOREIGN KEY (`location_id`) REFERENCES `locations` (`id`) ON DELETE RESTRICT ON UPDATE RESTRICT,
  CONSTRAINT `reports_ibfk_7` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`) ON DELETE SET NULL ON UPDATE RESTRICT
) ENGINE=InnoDB AUTO_INCREMENT=26 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin;


-----------------------------
Trigger : 


USE basmadb;
DELIMITER $$

CREATE DEFINER=`root`@`localhost` TRIGGER `trg_reports_set_reported_by_name`
BEFORE INSERT ON `reports`
FOR EACH ROW
BEGIN
    DECLARE v_name_ar VARCHAR(200);

    -- لو الـ SELECT ما رجّع صف، ما نبغى التريغر يرمي خطأ
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET v_name_ar = NULL;

    -- لو في user_id و reported_by_name فاضي/NULL، نعبّيه تلقائياً
    IF NEW.user_id IS NOT NULL
       AND (NEW.reported_by_name IS NULL OR NEW.reported_by_name = '') THEN

        -- نجلب الاسم بالعربي حسب نوع المستخدم
        SELECT 
            CASE 
                WHEN u.user_type = 3 THEN c.name_ar      -- مواطن
                WHEN u.user_type = 2 THEN i.name_ar      -- مبادرة
                ELSE NULL
            END
        INTO v_name_ar
        FROM users u
        LEFT JOIN citizens   c ON c.id = u.citizen_id
        LEFT JOIN initiatives i ON i.id = u.initiative_id
        WHERE u.id = NEW.user_id
        LIMIT 1;

        -- لو لقينا اسم بالعربي، نحطه في reported_by_name
        IF v_name_ar IS NOT NULL THEN
            SET NEW.reported_by_name = v_name_ar;
        END IF;
    END IF;
END$$

DELIMITER ;
